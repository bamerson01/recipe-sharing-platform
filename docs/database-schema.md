# Database Schema

## Overview

The RecipeNest platform uses a PostgreSQL database hosted on Supabase with comprehensive Row Level Security (RLS) policies, triggers, and functions. The schema is designed for scalability, security, and performance with proper indexing and constraint management.

## Core Tables

### Users & Profiles

#### `profiles` Table
**Purpose**: Stores user profile information and social metrics

```sql
CREATE TABLE public.profiles (
  id uuid PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  username text UNIQUE NOT NULL,
  display_name text,
  avatar_key text,
  bio text,
  follower_count integer DEFAULT 0,
  following_count integer DEFAULT 0,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

**Column Details**:
- `id`: Primary key, references Supabase auth.users table
- `username`: Unique identifier for URLs and mentions (e.g., `/u/username`)
- `display_name`: Human-readable name for UI display
- `avatar_key`: Storage key for profile picture in `avatars` bucket
- `bio`: User biography text (nullable)
- `follower_count`: Cached count of users following this profile
- `following_count`: Cached count of users this profile follows
- `created_at`: Profile creation timestamp
- `updated_at`: Last profile update timestamp

**Constraints**:
- Primary key on `id`
- Unique constraint on `username`
- Foreign key to `auth.users(id)` with CASCADE delete

**Indexes**:
- `idx_profiles_username` on `username` for fast username lookups
- `idx_profiles_created_at` on `created_at` for chronological sorting

**Business Logic**:
- Username must be unique across all users
- Follower/following counts are maintained by database triggers
- Avatar uploads automatically update `avatar_key` field

### Recipe Management

#### `recipes` Table
**Purpose**: Stores recipe metadata, content, and engagement metrics

```sql
CREATE TABLE public.recipes (
  id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  author_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  title text NOT NULL,
  slug text NOT NULL,
  summary text,
  cover_image_key text,
  is_public boolean DEFAULT false,
  like_count integer DEFAULT 0,
  search_vector tsvector,
  difficulty text CHECK (difficulty IN ('Easy', 'Medium', 'Hard')),
  prep_time integer CHECK (prep_time > 0),
  cook_time integer CHECK (cook_time > 0),
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

**Column Details**:
- `id`: Auto-incrementing primary key for recipes
- `author_id`: References the profile that created the recipe
- `title`: Recipe name (required)
- `slug`: URL-friendly identifier (e.g., `chocolate-chip-cookies`)
- `summary`: Brief description of the recipe
- `cover_image_key`: Storage key for recipe cover image
- `is_public`: Visibility flag (false = private, true = public)
- `like_count`: Cached count of likes on this recipe
- `search_vector`: Full-text search vector for PostgreSQL search
- `difficulty`: Recipe difficulty level (constrained to Easy/Medium/Hard)
- `prep_time`: Preparation time in minutes
- `cook_time`: Cooking time in minutes
- `created_at`: Recipe creation timestamp
- `updated_at`: Last modification timestamp

**Constraints**:
- Primary key on `id`
- Foreign key to `profiles(id)` with CASCADE delete
- Check constraint on `difficulty` values
- Check constraints on time values (must be positive)

**Indexes**:
- `idx_recipes_author_id` on `author_id` for author-based queries
- `idx_recipes_slug` on `slug` for URL lookups
- `idx_recipes_search_vector` on `search_vector` using GIN for full-text search
- `idx_recipes_created_at` on `created_at` for chronological sorting
- `idx_recipes_like_count` on `like_count` for popularity sorting
- `idx_recipes_is_public` on `is_public` for visibility filtering

**Business Logic**:
- Slug must be unique per author (enforced by application logic)
- Like count is maintained by database triggers
- Search vector is automatically updated via triggers
- Cover images are stored in `public-media` bucket

#### `recipe_ingredients` Table
**Purpose**: Stores structured ingredient lists for recipes

```sql
CREATE TABLE public.recipe_ingredients (
  id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  recipe_id bigint NOT NULL REFERENCES public.recipes(id) ON DELETE CASCADE,
  position integer NOT NULL,
  text text NOT NULL,
  created_at timestamptz DEFAULT now()
);
```

**Column Details**:
- `id`: Auto-incrementing primary key
- `recipe_id`: References the parent recipe
- `position`: Order of ingredient in the recipe (1, 2, 3...)
- `text`: Ingredient description (e.g., "2 cups all-purpose flour")
- `created_at`: Record creation timestamp

**Constraints**:
- Primary key on `id`
- Foreign key to `recipes(id)` with CASCADE delete
- Position must be positive integer

**Indexes**:
- `idx_recipe_ingredients_recipe_id` on `recipe_id` for recipe lookups
- `idx_recipe_ingredients_position` on `(recipe_id, position)` for ordered retrieval

#### `recipe_steps` Table
**Purpose**: Stores step-by-step cooking instructions

```sql
CREATE TABLE public.recipe_steps (
  id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  recipe_id bigint NOT NULL REFERENCES public.recipes(id) ON DELETE CASCADE,
  position integer NOT NULL,
  text text NOT NULL,
  created_at timestamptz DEFAULT now()
);
```

**Column Details**:
- `id`: Auto-incrementing primary key
- `recipe_id`: References the parent recipe
- `position`: Order of step in the recipe (1, 2, 3...)
- `text`: Step instructions (e.g., "Preheat oven to 350Â°F")
- `created_at`: Record creation timestamp

**Constraints**:
- Primary key on `id`
- Foreign key to `recipes(id)` with CASCADE delete
- Position must be positive integer

**Indexes**:
- `idx_recipe_steps_recipe_id` on `recipe_id` for recipe lookups
- `idx_recipe_steps_position` on `(recipe_id, position)` for ordered retrieval

### Social Features

#### `follows` Table
**Purpose**: Manages user follow relationships for social networking

```sql
CREATE TABLE public.follows (
  id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  follower_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  followed_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  created_at timestamptz DEFAULT now()
);
```

**Column Details**:
- `id`: Auto-incrementing primary key
- `follower_id`: User who is following (references profiles.id)
- `followed_id`: User being followed (references profiles.id)
- `created_at`: When the follow relationship was established

**Constraints**:
- Primary key on `id`
- Foreign key to `profiles(id)` for both follower and followed
- Unique constraint on `(follower_id, followed_id)` prevents duplicate follows
- Check constraint ensures users cannot follow themselves

**Indexes**:
- `idx_follows_follower_id` on `follower_id` for following queries
- `idx_follows_followed_id` on `followed_id` for follower queries
- `idx_follows_created_at` on `created_at` for chronological sorting

**Business Logic**:
- Users cannot follow themselves (enforced by application logic)
- Follow relationships are bidirectional for counting purposes
- Follower/following counts are maintained by database triggers

#### `likes` Table
**Purpose**: Tracks user likes on recipes for engagement metrics

```sql
CREATE TABLE public.likes (
  id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  recipe_id bigint NOT NULL REFERENCES public.recipes(id) ON DELETE CASCADE,
  user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  created_at timestamptz DEFAULT now()
);
```

**Column Details**:
- `id`: Auto-incrementing primary key
- `recipe_id`: References the liked recipe
- `user_id`: References the user who liked the recipe
- `created_at`: When the like was created

**Constraints**:
- Primary key on `id`
- Foreign key to `recipes(id)` with CASCADE delete
- Foreign key to `profiles(id)` with CASCADE delete
- Unique constraint on `(recipe_id, user_id)` prevents duplicate likes

**Indexes**:
- `idx_likes_recipe_id` on `recipe_id` for recipe-based queries
- `idx_likes_user_id` on `user_id` for user-based queries
- `idx_likes_created_at` on `created_at` for chronological sorting

**Business Logic**:
- Users can only like a recipe once (enforced by unique constraint)
- Like counts are maintained by database triggers
- Likes are public and visible to all users

#### `saves` Table
**Purpose**: Private bookmarks for users to save recipes for later

```sql
CREATE TABLE public.saves (
  id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  recipe_id bigint NOT NULL REFERENCES public.recipes(id) ON DELETE CASCADE,
  user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  created_at timestamptz DEFAULT now()
);
```

**Column Details**:
- `id`: Auto-incrementing primary key
- `recipe_id`: References the saved recipe
- `user_id`: References the user who saved the recipe
- `created_at`: When the save was created

**Constraints**:
- Primary key on `id`
- Foreign key to `recipes(id)` with CASCADE delete
- Foreign key to `profiles(id)` with CASCADE delete
- Unique constraint on `(recipe_id, user_id)` prevents duplicate saves

**Indexes**:
- `idx_saves_recipe_id` on `recipe_id` for recipe-based queries
- `idx_saves_user_id` on `user_id` for user-based queries
- `idx_saves_created_at` on `created_at` for chronological sorting

**Business Logic**:
- Saves are private and only visible to the user who created them
- Users can only save a recipe once (enforced by unique constraint)
- Saves are not counted in public metrics

### Content & Categories

#### `categories` Table
**Purpose**: Organizes recipes into searchable categories

```sql
CREATE TABLE public.categories (
  id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  name text NOT NULL,
  slug text NOT NULL UNIQUE,
  created_at timestamptz DEFAULT now()
);
```

**Column Details**:
- `id`: Auto-incrementing primary key
- `name`: Human-readable category name (e.g., "Desserts")
- `slug`: URL-friendly identifier (e.g., "desserts")
- `created_at`: Category creation timestamp

**Constraints**:
- Primary key on `id`
- Unique constraint on `slug` for URL consistency

**Indexes**:
- `idx_categories_slug` on `slug` for URL lookups
- `idx_categories_name` on `name` for display purposes

#### `recipe_categories` Table
**Purpose**: Junction table for many-to-many recipe-category relationships

```sql
CREATE TABLE public.recipe_categories (
  recipe_id bigint NOT NULL REFERENCES public.recipes(id) ON DELETE CASCADE,
  category_id bigint NOT NULL REFERENCES public.categories(id) ON DELETE CASCADE,
  PRIMARY KEY (recipe_id, category_id)
);
```

**Column Details**:
- `recipe_id`: References the recipe
- `category_id`: References the category

**Constraints**:
- Composite primary key on `(recipe_id, category_id)`
- Foreign key to `recipes(id)` with CASCADE delete
- Foreign key to `categories(id)` with CASCADE delete

**Indexes**:
- Primary key automatically creates index on `(recipe_id, category_id)`
- Additional index on `category_id` for category-based queries

**Business Logic**:
- Recipes can belong to multiple categories
- Categories can contain multiple recipes
- Deleting a recipe removes all category associations

### User Interactions

#### `recipe_comments` Table
**Purpose**: Stores user comments on recipes for community engagement

```sql
CREATE TABLE public.recipe_comments (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  recipe_id bigint NOT NULL REFERENCES public.recipes(id) ON DELETE CASCADE,
  user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  body text NOT NULL,
  parent_id uuid REFERENCES public.recipe_comments(id) ON DELETE CASCADE,
  is_edited boolean DEFAULT false,
  edited_at timestamptz,
  like_count integer DEFAULT 0,
  created_at timestamptz DEFAULT now()
);
```

**Column Details**:
- `id`: UUID primary key for comments
- `recipe_id`: References the recipe being commented on
- `user_id`: References the comment author
- `body`: Comment text content
- `parent_id`: References parent comment for nested replies (nullable)
- `is_edited`: Flag indicating if comment has been modified
- `edited_at`: Timestamp of last edit
- `like_count`: Cached count of likes on this comment
- `created_at`: Comment creation timestamp

**Constraints**:
- Primary key on `id`
- Foreign key to `recipes(id)` with CASCADE delete
- Foreign key to `profiles(id)` with CASCADE delete
- Foreign key to `recipe_comments(id)` for nested replies
- Check constraint on `body` length (minimum 1 character)

**Indexes**:
- `idx_recipe_comments_recipe_id` on `recipe_id` for recipe-based queries
- `idx_recipe_comments_user_id` on `user_id` for user-based queries
- `idx_recipe_comments_parent_id` on `parent_id` for reply queries
- `idx_recipe_comments_created_at` on `created_at` for chronological sorting

**Business Logic**:
- Comments support nested replies via `parent_id`
- Edit tracking maintains comment history
- Like counts are maintained by database triggers
- Comments are public and visible to all users

## Foreign Key Relationships

### Primary Relationships

```
profiles (id) ââ recipes (author_id)
profiles (id) ââ follows (follower_id)
profiles (id) ââ follows (followed_id)
profiles (id) ââ likes (user_id)
profiles (id) ââ saves (user_id)
profiles (id) ââ recipe_comments (user_id)

recipes (id) ââ recipe_ingredients (recipe_id)
recipes (id) ââ recipe_steps (recipe_id)
recipes (id) ââ likes (recipe_id)
recipes (id) ââ saves (recipe_id)
recipes (id) ââ recipe_comments (recipe_id)
recipes (id) ââ recipe_categories (recipe_id)

categories (id) ââ recipe_categories (category_id)

recipe_comments (id) ââ recipe_comments (parent_id)
```

### Relationship Cardinality

- **One-to-Many**: Profile â Recipes, Profile â Comments, Recipe â Ingredients/Steps
- **Many-to-Many**: Recipes â Categories (via recipe_categories)
- **Self-Referential**: Comments can have nested replies
- **Social**: Follows create bidirectional relationships between profiles

## Unique Constraints

### Business Logic Enforcement

1. **`profiles.username`**: Ensures unique usernames across the platform
2. **`follows(follower_id, followed_id)`**: Prevents duplicate follow relationships
3. **`likes(recipe_id, user_id)`**: Prevents users from liking the same recipe multiple times
4. **`saves(recipe_id, user_id)`**: Prevents duplicate saves of the same recipe
5. **`categories.slug`**: Ensures unique category URLs

### Constraint Reasoning

- **Username uniqueness**: Required for URL routing and user identification
- **Follow uniqueness**: Prevents spam and maintains clean social graphs
- **Like/Save uniqueness**: Prevents data duplication and maintains accurate counts
- **Category slug uniqueness**: Required for consistent URL structure

## Indexes & Performance

### Primary Indexes
- All primary keys automatically create clustered indexes
- Foreign keys create indexes for join performance
- Composite indexes support common query patterns

### Search Optimization
- **GIN index on `recipes.search_vector`**: Enables fast full-text search
- **B-tree indexes on timestamps**: Support chronological sorting and filtering
- **Hash indexes on boolean fields**: Optimize visibility filtering

### Query Performance Considerations
- **Recipe listing**: Optimized with indexes on `is_public`, `created_at`, `like_count`
- **User content**: Fast retrieval with indexes on `author_id`, `user_id`
- **Social queries**: Efficient with indexes on follow relationships and timestamps

## Migration History

### Major Schema Changes

#### 2025-01-22: Follows Table Column Rename
- **Change**: Renamed `following_id` â `followed_id` in `follows` table
- **Reason**: Better semantic clarity (who is being followed vs. who is following)
- **Impact**: Updated all application code to use new column name
- **SQL**: `ALTER TABLE public.follows RENAME COLUMN following_id TO followed_id;`

#### 2025-01-21: Search Vector Addition
- **Change**: Added `search_vector` column to `recipes` table
- **Reason**: Enable full-text search across recipe content
- **Impact**: Improved search performance and user experience
- **SQL**: `ALTER TABLE public.recipes ADD COLUMN search_vector tsvector;`

#### 2025-01-20: Social Features Implementation
- **Change**: Added `follows`, `likes`, `saves` tables
- **Reason**: Enable social networking and user engagement features
- **Impact**: Complete social platform functionality
- **SQL**: Multiple CREATE TABLE statements with RLS policies

### Future Schema Considerations

#### Planned Enhancements
- **Recipe versions**: Support for recipe evolution and history
- **Advanced search**: Additional search vectors for ingredients and steps
- **Performance metrics**: User engagement and recipe popularity tracking
- **Content moderation**: Flagging and review systems for user-generated content

#### Scalability Considerations
- **Partitioning**: Large tables may benefit from time-based partitioning
- **Archiving**: Old content may be moved to archive tables
- **Caching**: Redis integration for frequently accessed data
- **CDN**: Image delivery optimization for global users

## Data Integrity

### Referential Integrity
- All foreign keys use CASCADE delete to maintain consistency
- Check constraints prevent invalid data entry
- Unique constraints prevent duplicate relationships

### Business Rule Enforcement
- Database triggers maintain calculated fields (counts, timestamps)
- RLS policies enforce access control at the database level
- Application logic provides additional validation layers

### Audit Trail
- `created_at` and `updated_at` timestamps on all tables
- Edit tracking for user-generated content
- Comprehensive logging for security and debugging

## Security Considerations

### Row Level Security (RLS)
- All tables have RLS policies enabled
- Policies enforce user-based access control
- Service role access limited to specific operations

### Data Privacy
- Private recipes only visible to owners
- User saves are completely private
- Profile information has configurable visibility

### Input Validation
- Database constraints prevent invalid data
- Application-level validation with Zod schemas
- SQL injection protection via parameterized queries 